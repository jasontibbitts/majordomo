2000-08-27  Michael Yount <csf@moscow.com>

	* bin/mj_*, setup/query_util.pl :  Allow only letters, digits, 
	period and hyphen in domain names when untainting.

	* bin/mj_email, bin/mj_queuerun:  Look for the "x-loop" header
	in messages containing commands, and forward such a message to the 
	list owner.

	* bin/mj_wwwusr:  Add a button for the alias command.

	* files/en/config/triggers:  New file.  Describe the new
	triggers configuration setting, which determines at what
	times the hourly trigger will invoke a particular trigger.

	* lib/Majordomo.pm (trigger):  Evaluate the triggers configuration
	setting during the hourly trigger.

	* lib/Mj/Config.pm (parse_triggers):  New routine.  Each line
	of the triggers setting contains a trigger name and set of
	times at which the trigger should be invoked.
	(_str_to_clock)  Parse "yearly" "quarterly" "monthly" "daily"
	and a new abbreviated format (e.g., 7m3d(8) for July 3, 8 am).

	* lib/Mj/Digest.pm (in_clock):  Handle hours relative to the 
	start of a year, or relative to the start of a particular month.

	* lib/Mj/Resend.pm (_r_strip_body):  New routine.  Discard
	attachments as required by the attachment_rules setting.

2000-08-24  Darren Stalder  <torin@daft.com>

	* README: After the setup questions are asked, mention that you
	can prepare and use a response file.

	* setup/query_util.pl (prompt): Allow prompt to read from STDIN if
	there is any data waiting there.  This allows the installer to
	prepare a response file for the questions; very useful for
	packaging mj2.

2000-08-24  Michael Yount <csf@moscow.com>

	* bin/mj_wwwusr:  Include digests when the details about
	an individual list are shown.

	* lib/Majordomo.pm: (lists) Include digest names and
	descriptions in the data.
	(_report) Allow more complicated time spans, e.g.,
	2w3d4h for the last 2 weeks, 3 days, and 4 hours.
	(Thanks to Dave Wolfe for the suggestion.)
	(trigger) Add new trigger options for finer control.
	The following abbreviations are available:
	b (bounce) or v (vacation) ... expire bounce and vacation data.
	c (checksum) ... expire duplicate checksum/id data.
	da (daily) ... all of the other tasks, except digests.
	di (digest) or h (hourly) ... issue digests.
	l (log) ... expire old log entries.
	s (session) ... expire old session data.
	t (token) ... expire old tokens and temporary passwords.

	* lib/Mj/BounceParser.pm (parse): Anchor matches at the
	beginning of the envelope information.

	* lib/Mj/Format.pm (lists):  Display digests in "aux" mode.

	* lib/Mj/List.pm: (_time_to_str) New routine.  Convert a
	time span abbreviation (such as 2w3d4h) to a count of seconds.
	(describe_class) Deal with vacation spans correctly.

2000-08-23  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (lists, who_start):  Treat a search
	pattern not enclosed in delimiters to a case-insensitive
	substring match.

2000-08-21  Michael Yount <csf@moscow.com>

	* files/en/config/archive_url:  New configuration
	variable, used by mj_wwwusr and the message_headers
	setting (ARCURL substitution in Mj::Resend::_post.)

	* files/en/config/sublists:  New configuration variable.
	The lists-aux command will only display auxiliary lists
	explicity mentioned in this setting.  The createlist-regen
	command will only create mail aliases for sublists included
	in this setting.  Each line of the array consists of
	a sublist name, followed by an optional description.
	The description appears in the output of the lists-aux 
	command.

	* bin/mj_wwwusr:  Overhaul formatting.  The introductory
	page is now very simple, offering only instructions.  The
	lists page contains a link to a separate page for each mailing 
        list.

	* lib/Majordomo.pm: (get_all_lists) Take a regular expression,
	to allow the list names to be searched.
	(list_config_set_to_default) Remove calls to inform().
	(_createlist) Create aliases only for auxiliary lists
	named in the "sublists" configuration setting.
	(lists) Allow a regular expression to be used, to search
	the list of lists.  Add new data (list address, owner
	address, number of subscribers, archive URL) to the 
	output of the lists-aux command.
	(report_done) Include a list of auxiliary lists in
	summary mode, to compensate for the new restrictions
	to the lists-aux command.
	
	* lib/Mj/Config.pm (parse_sublist_array):  New routine.
	Used with the "sublists" variable.  Each line consists
	of a list name, followed by an optional description.

	* lib/Mj/List.pm (count_subs):  New routine.  Count
	the number of subscribers in a list or auxiliary list.

2000-08-20  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/Resend.pm: Strip trailing whitespace in code.

	* lib/Mj/MailOut.pm (mail_message): Fix undeclared variable
	problem.
	Strip trailing whitespace in code.
	(handle_bounce_user): Take all arguments in a hash.

	* lib/Mj/Config.pm (parse_bounce_rules): New function to parse
	bounce_rules variable.  Works mostly like parse_delivery_rules.
	Strip trailing whitespace in code.
	Hook up parse_bounce_rules function to the appropriate type.
	(_compile_rule): Fix handling of two-character numeric
	comparisons, which have been broken for forever.

	* lib/Mj/CommandProps.pm: Add variables and actions for "_bounce"
	fake command, for use in bounce_rules.
	Strip trailing whitespace in code.

	* bin/mj_queuerun: Strip trailing whitespace in the code.

	* lib/Mj/MailOut.pm (handle_bounce): Split out 'M'-type bounce
	processing, like we did with 'T'-type bounces.
	(handle_bounce_message): New function to deal with bounced
	messages.

	* lib/Mj/List.pm (bounce_add): Add logging.

2000-08-19  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/BounceParser.pm (parse_msn): Add parser for MSN-format
	bounces.

	* lib/Mj/Config.pm (_compile_rule): Fix broken operator comparison
	regexp.

2000-08-19  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (_digest):  Add "status" mode,
	which allows the current state of the digests to be 
	viewed.

	* lib/Mj/Token.pm (gen_latchkey):  Use new "latchkey_lifetime"
	global configuration variable, which gives the lifetime of
	a temporary password in minutes.

2000-08-18  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (_rekey):  Allow the registry
	to be verified or repaired, based upon the subscriber
	databases, if the registry is corrupted.

2000-08-15  Michael Yount <csf@moscow.com>

	* bin/mj_wwwadm:  Further refine the output of
	the configshow command (menus for enumerated types,
	add links to help pages).

	* files/en/config/log_lifetime:  New variable.  Log
	entries older than this age (default 31 days) will be
	deleted during the daily trigger.

	* lib/Majordomo.pm (set):  Support "check" mode, which
	allows settings to be reviewed but not changed.

	* lib/Mj/CommandProps.pm, lib/Mj/Parser.pm (parse_args):  
	Rearrange 'arguments' data to make per-mode adjustments easier.

	* lib/Mj/Inform.pm (l_expire):  New routine.  Remove log
	entries older than the log_lifetime setting.

2000-08-13  Michael Yount <csf@moscow.com>

	* files/en/ack_archive:  New file, sent when a post is
	archived but not distributed.

	* bin/mj_wwwadm:  Add forms to the output of the configshow
	command to allow settings to be changed or set to the default.
	(only one setting at a time may be changed)

	* lib/Majordomo.pm: (_alias_reverse_lookup) Optionally
	include the bookkeeping alias in the result.  Return
	keys instead of stripsource values.
	(alias) Use list instead of listref error return values.
	(configshow) Indicate if a global password is 
	required to change a particular variable.
	(_changeaddr) Replace the bookkeeping alias correctly.
	(reject) Allow DATE substitution (date of original request).
	(set, _set) Use "check" and "force" variables to allow
	settings to be seen without changing them, and to allow
	list owners to override allowed_* settings that limit
	the changes available to subscribers.

	* lib/mj_cf_data.pl: Remove ack_denials_always.
	Add values for 'flags' variables to allow sanity checks.

	* lib/Mj/Config.pm (parse_flags):  Check the validity
	of flags in list settings (allowed_flags, aliases, ...)

	* lib/Mj/List.pm: (%flags) Add ackdeny, ackpost, ackreject,
	and ackstall settings for fine-grained selection of acknowledgements.
	(set) Implement allowed_classes and allowed_flags checks,
	which limit the settings which may be changed by subscribers.
	(make_setting) Deal with group settings: the ackall and
	ackimportant flags now turn on all of the individual ack flags,
	and the noack flag turns them all off.
	(should_ack) New routine.  Determine whether a certain action
	requires an ack to be sent to the victim.
	(aux_get_member) New routine.  Return the auxiliary list
	data for a particular address.
        
	* lib/Mj/Resend.pm: (post) Include the sublist, date,
	and message author in the variable substitutions.
	(_post) Send an acknowledgement if warranted.

	* lib/Mj/Token.pm (t_accept):  Acks for posted messages
	are handled by Mj::Resend::_post.  Determine if an
	ack was sent in this case.

2000-08-12  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/mj_cf_data.pl: Add bounce_rules variable.

	* lib/Mj/MailOut.pm (handle_bounce): Fix busted indentation.

2000-08-10  Michael Yount <csf@moscow.com>

	* lib/Mj/Access.pm (list_access_check):  Allow reasons
	to be described for commands other than "post."

	* lib/Mj/Config.pm (parse_table):  Allow parens within
	quotes and vice-versa when parsing multifield lines.

2000-08-09  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm:  (dispatch) Treat an "owner" command as
	a "bounce" during inform() if a bad address was supplied.
	Set the "user" to the message author and put bad addresses
	into the command line variable.

	* lib/Mj/MailOut.pm (handle_bounce):  Return the bad
	addresses (if any were found) and message author (always).

	* bin/mj_wwwadm, lib/Mj/Format.pm (who):  Show bounce diagnostics.

	* lib/Mj/List.pm (bounce_add),  lib/Mj/SubscriberList.pm: 
	Add bounce diagnostics to saved/displayed data.

	* lib/Mj/Deliver/Dest.pm, lib/Mj/Deliver/Envelope.pm:
	Report non-fatal failures during RCPT TO as pseudo-exim bounces
	to the message sender. (Thanks to Paul Hancock.)

2000-08-08  Michael Yount <csf@moscow.com>

	* files/en/wwwadm_head, files/en/wwwadm_help:  Move the 
	command form and introduction from mj_wwwadm to separate files
	to allow easier customization.

	* lib/Mj/CommandProps.pm, lib/Mj/Parser.pm (parse_args):
	Split variable names in the configdef and configshow commands
	on either commas or spaces.

2000-08-07  Michael Yount <csf@moscow.com>
 
	* lib/Mj/Config.pm (set):  Initialize value if it is not 
	defined.  (Thanks to Todd Goodman.)

2000-08-06  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (_createlist):  Create the archive
	directory unless "noarchive" mode is specified.  Generate
	a password randomly.  Send the "new_list" file to the 
	owner unless "nowelcome" mode was specified.
	Add "destroy" mode, which will remove a list by renaming
	its directory, but only if there are no subscribers.
	Destroy mode also regenerates the aliases.

2000-08-05  Michael Yount <csf@moscow.com>

	* lib/Mj/List.pm (make_setting):  Allow nomail-return to
	work for vacations that are not timed.

2000-08-04  Michael Yount <csf@moscow.com>

	* bin/mj_email, bin/mj_enqueue:  delete unneeded envvars.

	* bin/mj_queuerun:  randomize directories and files. 
	Fix indentation.  

	* bin/mj_wwwadm:  simplify command form maintenance.

	* files/en/consult, files/en/consult_noweb:  Suggest
	that the accepter type an explanation.

	* lib/Majordomo.pm: (new) Treat the registry as
	a subscriber list for the GLOBAL list.  This allows
	the Deliver module to distribute messages to addresses
	in the registry.
	(announce) New command.  Distribute a file to one
	or more classes of subscribers.  Each message is
	sent as a probe, with the recipient in the To: header.
	This could be used for periodic reminders, or 
	announcements that need to reach 'digest' and 'nomail'
	subscribers immediately.
	(archive_chunk) Allow the type of digest for the
	archive-get command to be specified in the mode ("-mime"
	for mime; text otherwise.)
	(report) New, iterated command.  Obtain raw or summarized
	data for recent log entries for a mailing list.
	The data can be constrained by action or by date.
	(get_all_lists, _make_list) Make DEFAULT data available 
	to Mj::List::new when all of the lists are being 
	loaded, to save redundant lookups.

	* lib/mj_cf_defs.pl: Add 'MSGRCPT' to admin_header checks.

	* lib/Mj/CommandProps.pm, lib/Mj/Format.pm:  Support new
	announce and report commands.

	* lib/Mj/Config.pm:  Use existing data for the DEFAULT
	list when Majordomo::get_all_lists is run.

	* lib/Mj/Deliver.pm:  (deliver) Support delivery to 
	addresses in the registry.  Addresses subscribed to 
	at least one list are in the "each" class.  Addresses
	not subscribed to any lists are in the "nomail" class.

	* lib/Mj/List.pm:  (_digest_classes) New routine.  Return
	a list of all possible digest classes.

	* lib/Mj/MailOut.pm:  (probe) New routine.  Probe all
	addresses in the classes provided.  This is used by
	the announce command.

	* lib/Mj/Parser.pm:  (parse_entity) Test for existence
	of a bodyhandle before using it.  (Thanks to Paul Hancock.)

	* lib/Mj/Deliver/Dest.pm:  (make_envelope)  Add 'personal'
	variable, which is set if there is only one recipient.

	* lib/Mj/Deliver/Envelope.pm:  (new, address, send)
	If a message is personal, substitute the recipient's
	address for the variable $MSGRCPT during delivery.

2000-07-30  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm: (dispatch) Inform on post_done, but not
	on post_start.
	(set, who)  Use arg3 instead of arg2 for the auxiliary list,
	because arg2 is used by the access rules to offer reasons. 
	(accept)  Allow a comment to be given on the command line,
	as with the reject command.
	
	* lib/Mj/Access.pm: (list_access_check) Make the command mode 
	available to the access rules.

	* lib/Mj/Format.pm: (post) Do not print comment on success.
	(accept) Indicate whether or not the victim was notified.

	* lib/Mj/List.pm: (valid_aux) Rename validate_aux to valid_aux
	and use it to untaint the sublist name, ala valid_list.

2000-07-28  Michael Yount <csf@moscow.com>

	* lib/Mj/CommandProps.pm:  Use "auxlist" instead of "sublist."
	The argument names must be alphabetical in relation to the
	order in which the arguments appear on the command line.
	Using "auxlist" allows more flexibility in choosing names
	for the other arguments.

	* lib/Majordomo.pm, lib/Mj/Format.pm:  Combine code for
	the who and auxwho commands.
 
	* lib/Mj/List.pm (expire_subscriber_data): Expire auxiliary
	list data.

2000-07-27  Michael Yount <csf@moscow.com>

	* lib/Mj/Archive.pm:  Make archives of auxiliary lists available.
	(add_start)  Use time derived from the Date: header.
	
	* lib/Mj/Resend.pm (_post):  Archive messages sent to 
	auxiliary lists.

2000-07-26  Michael Yount <csf@moscow.com>

	* bin/mj_wwwadm:  Add support for multiple domains.

	* bin/mj_wwwusr:  Restructure to override Mj::Format routines
	for the help, lists, and show commands.  
	Add support for multiple domains.
	Add support for the help and changeaddr commands.
	(Thanks to Sudhakar Chandrasekharan for the help suggestion.)

	* lib/Majordomo.pm (subscribe):  Set the matches_list variable
	if someone attempts to add the -unsubscribe alias to the list.

2000-07-25  Michael Yount <csf@moscow.com>

	* bin/mj_email, bin/mj_enqueue: Add options for new aliases
	  -c COMMAND    Issue a command (-subscribe, -unsubscribe)
	  -M            Forward message to moderators (-moderator)
	  -x SUBLIST    Post a message to an auxiliary list.
	At present, qmail support does not include auxiliary lists.
	The -moderator alias follows the same conventions as the
	-owner alias.  The auxiliary list aliases follow the same
	conventions as the resend (main list) alias.
	(Thanks to Brock Rozen for suggesting the -(un)subscribe aliases.)
      
	* bin/mj_queuerun: Handle altered queue file names for new aliases.
	The file names will end with a comma, followed by an auxiliary
	list name or command name or 'M' (for -moderator).
	Remove the unused qmail code.

	* bin/mj_wwwadm, bin/mj_wwwusr: Add support for latchkeys. 
	Instead of sending the password back to the client with the
	results, a temporary password is created with a limited lifetime
	(one hour by default).

	* lib/Majordomo.pm: 
	(dispatch)  Convert a latchkey into a permanent password.
	(gen_cmdline) Take into consideration messages posted to
	auxiliary lists.
	(_createlist)  Use the "aliases" setting to determine
	which aliases to use.  Include alias and sublist data
	when using the MTAConfig module.
	(reject) Include datum concerning whether or not an 
	acknowledgement was sent to the victim.
	(set, _set) Allow use of the "aux" mode to change the 
	settings for an auxiliary list.

	* lib/Mj/Access.pm (_a_forward):  Allow a posted message
	to be forwarded to a different address.

	* lib/Mj/CommandProps.pm: Allow the "sublist" variable
	to be used by the access rules for the "post" command.
	Allow the use of auxiliary lists with the "set-aux" command.

	* lib/Mj/Deliver.pm (deliver):  Obtain the list of subscribers
	from an auxiliary list, if that is the destination.

	* lib/Mj/Format.pm: (auxwho)  Use expanded format, like
	the "who-enhanced" command.
	(reject) For consult tokens, indicate whether or not the
	victim was informed.
	(set) Indicate the sublist if "aux" mode is used.
	(tokeninfo) Indicate the number of approvals required.
  
	* lib/Mj/List.pm:  Cease using AddressList.pm.  Auxiliary
	lists now use the SubscriberList module.
	(set, make_setting) Allow settings to be changed for 
	auxiliary lists.  Digest mode is not supported for sublists.
	Ensure that digest names are converted to lower case.
	(aux_add) Extend the data to accommodate the fields of
	a SubscriberList.
	(aux_get_chunk) Return all of the data instead of just the address.
	(aux_get_matching) New subroutine.
	(aux_rekey) Allow an easy transition from AddressList to 
	SubscriberList by rekeying.
	(moderators) New subroutine.  Obtain a list of moderators from
	1) A named auxiliary list
	2) The 'moderators' auxiliary list
	3) The 'moderators' configuration setting
	4) The 'moderator' configuration setting
	5) The 'sender' configuration setting
	in decreasing order of precedence.
	(_make_aux) Use SubscriberList instead of AddressList
	(validate_aux) New subroutine. Initialize an auxiliary list if it
	already exists.

	lib/Mj/MTAConfig.pm: (add_alias) Allow the use of optional
	(moderator, subscribe, unsubscribe, and auxiliary list) aliases.
	(regen_aliases) Sort the lists alphabetically.

	lib/Mj/MailOut.pm: (deliver) Add the sublist to the argument list.
	(owner_done) Direct the message to the moderators instead of
	the owner, if required.

	lib/Mj/Resend.pm: (post, _post) Allow messages to be posted
	to auxiliary lists.  Add 'sublist' to the access variables.
	Do not increase the sequence number, archive the message,
	or issue digests if the message is posted to a sublist.

	lib/Mj/Token.pm: (consult) Allow moderator groups (auxiliary
	lists) and group sizes to be used.
	(t_expire) Expire latchkeys (temporary passwords).
	(_make_latchkeydb, gen_latchkey, validate_latchkey) New subroutines.
	Latchkeys are temporary passwords used by the WWW interfaces
	to prevent the CGI scripts from passing a permanent password
	back to the client.

2000-07-21  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (connect): Call inform() if a connection
	attempt fails due to access restrictions.
 
	* lib/Mj/Resend.pm (_add_fters): Avoid adding footers
	and fronters to multipart/alternative messages.
	(Thanks to Joe Tremblay.)

2000-07-18  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (reject):  Allow an explanation or a file to
	be specified when a token is rejected.  The usual variable
	substitutions are available for use in the file.

2000-07-17  Michael Yount <csf@moscow.com>

	* bin/mj_wwwadm:  Add hypertext links to help pages.
	(Thanks to Sudhakar Chandrasekharan for the suggestion.)

2000-07-16  Michael Yount <csf@moscow.com>

	* lib/Mj/TextOutput.pm:  Remove entirely.

	* lib/Majordomo.pm:  Remove the 'auth' variable from the
	request hash, and make the 'interface' variable specific
	to each session, rather than to each request.  This reduces
	the number of arguments to routines like global_config_get
	and list_access_check by 2.

2000-07-07  Michael Yount <csf@moscow.com>

	* lib/Mj/Parser.pm (parse_args):   Deal with attachments.  If a command 
	accepts here arguments and is iterated,  set the appropriate request
	variable to the attachment file handle.  Otherwise, read
	the data from the file handle into the argument array.
	(Only the post and put commands will use the file handle.)

2000-07-03  Michael Yount <csf@moscow.com>

	* bin/mj_confirm:  Include domain in HTML form (from Olivier Prenant).
	Use Format to present output of sessioninfo.
	Show the expiration date of a token.

2000-07-01  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/BounceParser.pm (parse_lotus): Would accept an all-blank
	bounce.
	(parse_softswitch): Would accept an all-blank bounce.

2000-07-01  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm: (archive_chunk)  Use existing
	Mj::List routines to retrieve messages in 'immediate' mode.

2000-06-30  Michael Yount <csf@moscow.com>

	* bin/mj_wwwadm: Formatting rewrite; override Mj::Format 
	routines for the showtokens, tokeninfo, and who commands.

	* lib/Majordomo.pm:
	(faq_start, info_start, intro_start) Remove temporary files.
	(createlist) Use "newlist" variable instead of "list."
	(sessioninfo) Rename to sessioninfo_start.  Treat
	sessioninfo as an iterated core routine.
	(showtokens) Allow tokens shown to be limited to a
	particular command.  Include the size of the spool
	file in the output for posted messages.

2000-06-27  Michael Yount <csf@moscow.com>

	Use new core function calling conventions.

2000-06-26  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Majordomo.pm (createlist): Return values were done
	improperly for some reason.

	* lib/Mj/BounceParser.pm: Renamed from Bf/Parser.pm.

2000-06-25  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/List.pm (bounce_gen_stats): Fixed calculation of overload
	stats.

	* Rotated old ChangeLog entries.

