2000-12-05  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/Config.pm (parse_bounce_rules): Fix off by one error in
	rule IDs.

	* lib/Mj/List.pm (bounce_gen_stats): Always generate all
	statistics.  

	Computation of consecutive bounce count was badly busted.
	
	* lib/Mj/Config.pm (parse_bounce_rules): The default action is
	'inform', not 'ignore'.

	* lib/Mj/BounceHandler.pm (handle_bounce_user): Import
	'action_terminal' from Mj::CommandProps.

	Since all stats are always generated, don't include some messages
	about statistics when they are meaningless.

	Enable the bounce_rules checking code; include the result in the
	report but don't actually do anything with is.
	
	* lib/Mj/CommandProps.pm: 'remove' is a terminal action.

2000-12-04  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/BounceHandler.pm (handle_bounce_message): Completely
	ignore warning bounces.

	* lib/Mj/CommandProps.pm: Revise actions for bounce_rules.

2000-12-04  Jason L Tibbitts III  <tibbs@math.uh.edu>

	* setup/ask_domain.pl (ask_domain): Make it clear that the
        expected answer to "What is the email address of the
        owner of this Majordomo installation" is not "majordomo-owner".

2000-12-03  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/List.pm (expire_subscriber_data): Bug fix: when all
	bounces expired, all were kept.

2000-12-02  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (dispatch):  Add simple command mode validation.

	* lib/Mj/List.pm (search):  Allow a count of results desired.

2000-12-01  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/MTAConfig.pm (add_alias): Fix bug in VUT owner-list
	entry.

	* lib/Mj/BounceParser.pm (parse_smtp32): Fix possible infloop.

2000-11-25  Michael Yount <csf@moscow.com>

	* setup/newdomain.pl:  Allow domains to be added
	to the installation using the "make domain" shell command.

2000-11-22  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/Format.pm: Correct various syntax errors.

2000-11-18  Michael Yount <csf@moscow.com>

	* README.CALLING:  Somewhat outdated file describing the 
	request hash calling conventions.

	* bin/mj_shell:  Add editing support for the get-edit
	command, which wraps a file in a put command, to allow
	easy editing and replacement using your favorite editor.

	* bin/mj_wwwadm, bin/mj_wwwusr:  Rewrite.  Move all formatting
	into Mj::Format.  List explicitly the supported commands.

	* files/en/error/*:  New error files.  Allow customization
	of error messages (only two are used at present).

	* files/en/format/*:  New format files.  Allow customization
	of command output (only commands that require special
	formatting in the WWW interfaces are included at present,
	such as the configshow, lists, and show commands.)

	* files/en/help/configset_*:  Change "Variable Groups" heading
	to "Category" and revise the categories used.

	* files/en/help/configshow:  Document "categories" mode, 
	including a list of all ten categories.

	* files/en/help/get:  Document "edit" mode, which wraps a
	file with a put command, to allow easy editing and replacement.

	* lib/Majordomo.pm:  (dispatch) Improve list validation.
	(standard_subs) Add DOMAIN and PWLENGTH substitutions.
	(substitute_vars_format)  New routine.  Allows more extensive
	line-based formatting, with the following new features:
          $HELP:LOZENGE   add a hypertext link to the "lozenge" help file
          ?COMMENT        skip this line if the COMMENT substitution is empty.
        Also, if a substitution value is a list reference, the formatting
        of lines in which the variable appears will be spread over multiple
	lines, one for each array element.  For example, in the lists command,
        the DESCRIPTION substitution is a list reference.  As a result,
        the following line in the format file:
          $LIST:-23 $DESCRIPTION
        will cause the list name to be displayed only on the first line,
	while the description may span several lines, all indented.
	(format_error) New routine.  Retrieve an error file and apply
	substitutions to it.  Return the result in a string.
        (format_get_string) New routine.  Obtain a format file as a string.
	(_get) Add support for the edit command mode.
	(help_start) Allow abbreviations of configset_ topics.  For example,
	  help configset_who_access
	can be abbreviated to
	  help who_access
	(password)  Use error files instead of hard-coded messages.
	(configshow)  Add support for the categories command mode.
	(createlist)  Allow multiple list owners to be specified,
	using a here document.

	* lib/Mj/Access.pm (list_access_check, validate_passwd):  
	Perform latchkey validation.

	* lib/Mj/Archive.pm (expand_range):  Allow mwdh time expansions
	in arguments containing sublists.

	* lib/Mj/Format.pm (configshow, lists, show, showtokens,
	tokeninfo, who):  Use file formatting instead of hard-coded
	output.

	* lib/Mj/List.pm:  (get_setting_data)  New routine.  Obtain data 
	about the personal settings for a list, including default and
	allowed values.
	
2000-11-15  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/BounceParser.pm (parse_qmail): Support multiline
	diagnostics.

	* lib/Mj/Deliver/Prober.pm (add): Don't use the canonical address
	in the envelope, since it makes it difficult to get back to the
	real address later.

	* lib/Mj/List.pm (_make_post_data): New function to create the
	posts database.
	(post_add, get_post_data, expire_post_data): Call _make_post_data.

	* lib/Mj/BounceHandler.pm (handle_bounce_message): Incorrectly
	used "bounce" instead of "failure" for bounce status.

	* lib/Mj/BounceParser.pm (parse_mms): Accept WorldSecure SMTP
	Relay bounces as well.
	(check_dsn_netscape): Handle an additional format.
	(parse_dsn): Call check_dsn_netscape when appropriate to pull out
	additional diags that check_dsn_diags missed.

	* bin/mj_enqueue: Support -S option for qmail.

	* lib/Mj/BounceParser.pm (parse_postoffice): Handle older
	Post.Office bounces.
	(parse_mms): New function to parse Tumbleweed MMS bounces.

2000-11-14  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* t/bounce.t: Clear out @expect array between tests.

	* lib/Mj/BounceParser.pm (parse_postoffice): Restructure to fix
	several warnings.

	* lib/Mj/Deliver/Dest.pm (add): Accept null second argument.

2000-11-01  Jason L Tibbitts III  <tibbs@math.uh.edu>

	* lib/Mj/Parser.pm (parse_part): Fix undef warning with "default
        password".  Use a better message in this case.

	* bin/mj_shell (parse_command): Use better message when
        "default password" is used to clear out a default password.

2000-10-28  Michael Yount <csf@moscow.com>

	* files/en/help/*:  Document previously undocumented modes.
	Add a paragraph about comments within here documents to the
	appropriate configuration setting files.  Describe configuration
	templates.  Demonstrate the use of here documents with the
	subscribe and unsubscribe commands.

	* lib/Majordomo.pm:   (common_subs)  New routine.  Find the
	addresses that are present in two or more subscriber lists.
	(config_get_vars)  Make non-secure settings of DEFAULT lists
	visible.
	(list_config_set)  Support "extract" mode, which removes a
	set of values from an array, or sets an existing value to
	its default if the existing value and extracted value are
	identical.
	(compare_arrays) New routine, from the perl FAQ.
	(lists) Show the private auxiliary lists (in aux mode) and
	private configuration templates (in config mode) if a
	list-specific master password is used.  Show the DEFAULT
	templates (in config mode) if a pattern matching DEFAULT
	is used.
	(rekey) Return to old behavior:  do not verify by default.
	(set) Add support for patterns using "pattern," "regex,"
	and "allmatching" modes.
	(who) Add support for "common" mode, which displays the 
	addresses held in common by two mailing lists.

	* lib/Mj/Access.pm (list_access_check):  Do not fail if
	the lists command was provided with a non-GLOBAL password.
	List-specific passwords can be used to view private templates
	and sublists.

	* lib/Mj/CommandProps.pm:  List the supported modes
	for each command.

	* lib/Mj/Config.pm:  (parse_inform) Inform majordomo-owner
	about connection failures by default.

	* lib/Mj/Format.pm:  (configset) Support append and extract modes.
	(configshow)  Support append, extract, and merge modes.

	* lib/Mj/List.pm:  (get_chunk) Return the canonical address
	with the rest of the data.

	* lib/Mj/Resend.pm:  (post) Initialize sublist (Thanks to SRE.)

	* lib/Mj/Token.pm:  (t_accept) Propagate the reasons (Thanks to SRE.)

	* lib/Mj/Deliver/Dest.pm:  (flush) Use empty envelope sender 
	(Thanks to Jason.)

2000-10-27  Jason L Tibbitts III  <tibbs@math.uh.edu>

	* bin/mj_queuerun (run_queue): If mj_enqueue was called with an
        explicit command to run, always run it regardless of the setting
        of request_answer.

2000-10-27  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* bin/mj_queuerun (run_queue): Make sure $debug2 is actually an
	integer; the config variable might be the empty string.
	(debug_to): Add some useful into to the logs to show when we
	switch to a different log.

2000-10-26  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* bin/mj_queuerun (run_queue): Maintain a count of how many times
	a queue file has been processed.  When this gets too large, assume
	that something is hosed, crank up the debug level, and store a
	separate debug log.

	* lib/Majordomo.pm (which): List::search now takes the sublist (or
	MAIN) as the first arg.

2000-10-26  Jason L Tibbitts III  <tibbs@math.uh.edu>

	* lib/Mj/BounceHandler.pm (handle_bounce_message): Include info on
	what list the bounce is from, for folks who filter all owner mail
	to one place.

2000-10-22  Michael Yount <csf@moscow.com>

	* CREDITS, README:  Suggest mj2-dev instead of majordomo-workers.

	* bin/mj_trigger:  Separate lock expiration from the other triggers.

	* lib/Majordomo.pm:  (connect)  Do not validate addresses
	for requests from the resend and owner interfaces.
	(dispatch) Simplify processing requests with multiple victims.
	(substitute_vars_string) Allow formatting widths.  For example,
	  $OWNER:48  would pad the list owner address out to 48 characters
	and right-justify it.
	(list_config_get, list_config_set, list_config_set_to_default)
	Support the storage of configuration templates on a per-list
	basis.  All variables in a configuration template are visible
	without the use of a password.
	(list_config_set)  Support "append" mode, which combines arrays
	of configuration settings.
	(list_set_config)  Change the configuration file ('MAIN' by default)
	which is used by a mailing list.  This allows configuration
	templates to be accessed without changing the call arguments.
	(lists) Use "full" mode to display supplemental data such
	as digest names, subscriber count, and list addresses.
	Add "config" mode to list configuration templates.  The
	descriptions for templates are taken from the comments setting.
	(report) Add "succeed," "stall," and "fail" modes to 
	differentiate log entries according to the result.

	* lib/Mj/Access.pm:  (list_access_check) Make the name of
	the interface available to the access rules.

	* lib/Mj/Config.pm:  (is_array) Differentiate arrays that
	require blank lines between blocks from those that do not.
	(parse_table)  Treat lines beginning with (optional white
	space and) "#" as comments, and discard them during parsing.
	(load)  Do not automatically create a configuration file
	for a template.

	* lib/Mj/Format.pm:  (report)  Display dates on a separate 
	line to conserve space.

	* lib/Mj/List.pm:  (_fill_config, _make_config, valid_config,
	set_config)  New routines to find, load, and validate 
	configuration templates.

	* lib/Mj/Resend.pm:  (post) Set the "invalid_from" access
	variable if the address in the From: header is invalid.

	* setup/setup_func.pl:  Include a crontab entry for lock expiration.

2000-10-20  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/BounceParser.pm (parse_exim): Put a space between the
	lines of a multiline diag.
	(parse_postfix): Handle warnings properly.

2000-10-20  Jason L Tibbitts III  <tibbs@math.uh.edu>

	* lib/Mj/BounceParser.pm (parse_exchange): Parse a variant of the
        exchange format.

2000-10-19  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/Config.pm (_defaults): When an eval of the defaults
	string fails, print it out.

	* t/core.t: Clean up a bit.

	* t/shell.t: Set some variables to allow non-internet-connected
	hosts to run the tests.

	* lib/Mj/List.pm (remove): Mode "pattern" is valid for
	unsubscribe, but "regex" needs to be passed to the database
	routines.

2000-10-18  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (_who):  Display aliasing commands
	in "alias" mode for the GLOBAL list.  Display register
	commands with passwords with the "who-export GLOBAL"
	command.  Add sublist support to "export" mode.

2000-10-15  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm:  (auxadd, auxremove, auxwho) Merge
	auxiliary list commands with their common counterparts,
	subscribe, unsubscribe, and who.
	(rekey)  Rekeying automatically verifies the contents
	of the subscriber lists and registry.  Using "repair"
	mode will cause both to be repaired.
	(who)  Add preliminary support for "alias" mode, which
	will display the contents of the aliases database.
	(_make_list)  Use the stored values for the installation
	defaults from the DEFAULT list to avoid reloading them
	for every list.
	(dispatch)  Separate list:sublist into separate request hash
	variables.
        (config_get_vars)  All settings of the DEFAULT list are visible.
	(valid_list)  Understand and untaint list:sublist combination.

	* lib/Mj/Access.pm: (list_access_check)  Use GLOBAL checks 
	for the DEFAULT list.
	(_a_default)  "deny" by default if a sublist other than 'MAIN' is used.

	* lib/Mj/Config.pm:  (parse_address, parse_pw)  Allow
	$LIST substitution to avoid having to reload the installation
	defaults for each mailing list.
	(load) Rearrange the data structures for storing configuration
	information.

	* lib/Mj/List.pm:  (add, get, is_subscriber, et cetera)  
	Merge main subscriber list and auxiliary list code.
	(aux_rekey) Always run verification checks against the registry when
	rekeying.  Return data about missing entries.

2000-10-14  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* bin/mj_queueserv (in): Triple timeout when waiting for queue
	runner to start up.

2000-10-11  Jason L Tibbitts III  <tibbs@math.uh.edu>

	* bin/mj_email (connect_no_parse, connect_and_parse): Call
        Majordomo::connect in a list context so failed connects don't
        screw us up.  Log failed connects.

2000-10-07  Michael Yount <csf@moscow.com>

	* bin/mj_shell (parse_interactive):  Remove unneeded white space.

	* lib/Majordomo.pm (accept):  Track elapsed time for each token
	individually.
	(_subscribe):  Use "set" mode to allow settings to be included
	in a subscription command.  For example,
	  subscribe-set LIST digest
	is used instead of 
	  subscribe-digest LIST
	
2000-10-05  Jason L Tibbitts III  <tibbs@math.uh.edu>

	* bin/mj_shell (parse_interactive): Term::ReadLine can spew
        warnings over files we can't control; turn warnings off when
        loading it.

	* lib/Mj/Token.pm: Clean up various undeclared variable warnings.

2000-10-04  Jason L Tibbitts III  <tibbs@math.uh.edu>

	* lib/Mj/Access.pm (_d_post): Fix error when checking
        restrict_post.

2000-10-04  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (trigger):  Use the list-specific triggers
	setting to determine when the bounce, checksum, and post
	triggers will be run.

2000-10-03  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Majordomo.pm: Use BounceHandler module; set ISA
	appropriately.

	* lib/Mj/MailOut.pm: Remove bounce handling stuff.

	* lib/Mj/BounceHandler.pm: New file: handle bounces.

	* bin/mj_shell: Add option to dump request and result structures.

	* lib/Majordomo.pm (dispatch): Eliminate warnings when mode is
	empty or contains all non-alphabetics.

2000-10-02  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (dispatch):  Inform on *_done commands.
	Do not inform on *_start commands if they succeed.
	Track the elapsed time taken by a request.

	* lib/Mj/Format.pm (report):  Display the elapsed time
	if one is given.

	* lib/Mj/Inform.pm (inform):  Store the elapsed time of
	the command in the log.
	(_inform_owner)  Include TIME substitution, for the elapsed time.

	* lib/Mj/Log.pm (elapsed):  New routine.  Return the amount
	of time elapsed since the first call to in().

2000-10-02  Jason L Tibbitts III  <tibbs@math.uh.edu>

	* lib/Mj/Resend.pm (_check_mime): Don't fault messages for
        exceeding max_mime_header_length if it is zero.

2000-10-01  Michael Yount <csf@moscow.com>

	* lib/Mj/Resend.pm (_post):  Add support for the "unique"
	class.  Subscribers with this setting will not receive
	a duplicate copy if a message with the same ID or checksum
	has previously been posted to a list in the same domain.

2000-09-30  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Majordomo.pm: Bump version number.

	* lib/Mj/BounceParser.pm (parse_msn): Handle MSN bounces with
	multiline diagnostics.
	(parse_compuserve): Old function moved to parse_compuserve2.  New
	function to parse new bounce format.
	(parse_exim): Look at X-Failed-Recipients: header as well.

	* lib/Mj/SimpleDB/Text.pm: Use Majordomo::_re_match instead of
	local version.  Delete local copy.

	* lib/Majordomo.pm: Declare various undeclared variables.

	* lib/Mj/SimpleDB/DB.pm: Use Majordomo::_re_match for all regexp
	work.  Delete the local copy.

2000-09-29  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* bin/mj_shell: Add commented out code to get backtraces on
	warnings.
	Set $/ to $/ to get rid of a strange Perl problem.

	* lib/Majordomo.pm (substitute_vars): Was opening the input file
	twice.

2000-09-26  Michael Yount <csf@moscow.com>

	* lib/Mj/Config.pm (_compile_rule):  Add support for a 
	time specification within asterisks, similar to the
	digest "times" field.

2000-09-24  Michael Yount <csf@moscow.com>

	* files/en/ack_delay, delay, delay_noweb, repl_delay, 
	repl_fulfill:  New reply files for "delay" tokens.
	(Idea suggested by Marc Fournier.)

	* bin/mj_email, mj_queuerun:  Determine author's address.
	This allows the global 'access' checks to restrict posted
	messages and messages to list owners.

	* bin/mj_shell:  Add support for the default command
	in interactive mode (delay, password, and user only).

	* bin/mj_wwwadm:  Obtain token reasons from the reasons
	variable instead of arg2.

	* lib/Majordomo.pm:  Simplify calls to *_access_check.
	(trigger) Add "delay" trigger to fulfill delayed requests.

	* lib/Mj/Access.pm:  (_gen_pw) Accept an argument specifying
	the minimum password length.
	(list_access_check)  Use a hash instead of a long argument list.
	If the master password is used, and a delay was requested,
	delay the command.  Simplify calls to action routines (_a_*).
        Remove _a_denymess and _d_password.  Add _a_delay routine to
	handle the new "delay" action.

	* lib/Mj/Archive.pm (find):  New routine.  Find a list of
	archive files matching a pattern.  (Suggested by SRE)

	* lib/Mj/Config.pm:  (_load_dfl) Do not allow the GLOBAL list
	to use the DEFAULT settings.
	(compile_pattern)  Allow a leading "!" to indicate inversion.

	* lib/Mj/Format.pm (archive):  Synchronize multiple archives
	with one command using one-archive chunks.

	* lib/Mj/List.pm:  (archive_find) New wrapper for Mj::Archive::find.
	(_str_to_time) Allow a whole number to indicate a number of seconds.

	* lib/Mj/MIMEParser.pm (replace_headers):  Parse a file containing
	a message and add, replace, or delete some of the message headers.

	* lib/Mj/MailOut.pm (handle_bounce_token):  Do not delete a
	delay token (type 'D') when a message bounces.

	* lib/Mj/Parser.pm (parse_part):  Add support for the 
	"default delay" command.

	* lib/Mj/Resend.pm (post):  Return the error message for
	a stalled or denied post, which will appear in 'inform'
	messages mailed to the owners.

	* lib/Mj/Token.pm:  (delay)  New routine.  Create delay tokens,
	for requests which are completed when the token expires.
	(t_accept)  Always requeue posted messages with an "Approved" header
	added, to speed the reply to the accepter.
	(t_fulfill)  New routine.  Expire delay tokens and complete
	their requests.

	* lib/Mj/TokenDB.pm:  Add "reasons" field.  Store reasons
	there instead of in the arg2 fields.

	* lib/Mj/Digest/Build.pm (idx_numbered):  Add new "numbered"
	digest index format.

2000-09-11  Michael Yount <csf@moscow.com>

	* lib/Mj/Archive.pm (remove, sync, _sync_msgs): New routines.
	Allow groups of messages to be deleted from the archives,
	and individual archive files to be indexed, with the archive-delete
	and archive-sync commands.

2000-09-06  Michael Yount <csf@moscow.com>

	* files/en/config/post_limits:  New local configuration
	setting.  Each line consists of a pattern, followed by
	comma-separated lists of soft and hard limits.  By default,
	messages exceeding a soft limit are bounced to the moderators,
	while messages exceeding a hard limit are denied.

	* lib/Majordomo.pm: (_lists) In aux mode, include a count
	of posted messages in the last 30 days.
	(trigger) Add new "post" trigger, which removed old data
	from the post database.  The data have a lifetime twice
	that of the duplicate database.

	* lib/Mj/Access.pm (_d_post):  Add "limit_soft" to the list
	of consult variables, and "limit_hard" to the list of deny
	variables.

        * lib/Mj/Archive.pm: (first_n, last_n)  Collect data more quickly.
	(expand_range)  Allow use of "mwdh" format to specify "last 3 weeks"
	and similar ages.
	(get_all_data)  New routine.  Load all data from an archive index.

	* lib/Mj/Config.pm (parse_limits):  New routine.  Parse the
	post_limits variable into a format similar to the digest times.

	* lib/Mj/List.pm:  (_time_to_str) Allow "long" format output
	("2 days" instead of "2d").
	(post_add, get_post_data, expire_post_data) New routines to 
	handle the "posts" database, which records times and sequence
	numbers for posted messages, keyed on the e-mail address of
	the authors.
	(count_posts) New routine.  Total the posts to a list over
	a number of days, based upon the archive data.

	* lib/Mj/Resend.pm:  (_post)  Add the data about a post to
	the "posts" database after delivery.
	(_check_poster)  Determine if a message falls within limits.
	(_within_limits)  New routine.  Use the post_limits setting
	and data from the posts database to determine if a hard
	or soft limit is exceeded.
    
2000-08-31  Michael Yount <csf@moscow.com>

	* files/en/config/block_headers:  New global configuration
	setting.  Connections on the email and request interfaces
	will be dropped (and the site administrator informed) if
	headers of the incoming message match the regular expressions
	in this setting.

	* bin/mj_email, bin/mj_queuerun:  Instead of adding a 
	hard-coded reply-to header when sending command results,
	use the global message_headers setting to add headers
	(x-loop and reply-to headers are added by default).

	* bin/mj_wwwadm and others:  Use COMMAND variable substitution
	for a majordomo command instead of REQUEST.  REQUEST is used
	to indicate the LIST-request address.

	* lib/Majordomo.pm: (connect) Block connection if request
	message headers match patterns in the block_headers setting.
	(standard_subs) New routine.  Return a hash containing 
	common variable substitutions.

	* lib/Mj/Access.pm (check_headers): New routine.  Determine
	if the headers of a request message match the patterns in
	the block_headers setting.

	* lib/Mj/Token.pm (confirm, consult, remind):  Add headers
	from the global message_headers setting.

2000-08-30  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (_set):  Issue a partial digest when the
	delivery mode changes from digest to each.

	* lib/Mj/Resend.pm (_post):  Add SUBSCRIBED substitution,
	which is converted to "not" if the message author is not
	subscribed, or an empty string otherwise.

2000-08-27  Michael Yount <csf@moscow.com>

	* bin/mj_*, setup/query_util.pl :  Allow only letters, digits, 
	period and hyphen in domain names when untainting.

	* bin/mj_email, bin/mj_queuerun:  Look for the "x-loop" header
	in messages containing commands, and forward such a message to the 
	list owner.

	* bin/mj_wwwusr:  Add a button for the alias command.

	* files/en/config/triggers:  New file.  Describe the new
	triggers configuration setting, which determines at what
	times the hourly trigger will invoke a particular trigger.

	* lib/Majordomo.pm (trigger):  Evaluate the triggers configuration
	setting during the hourly trigger.

	* lib/Mj/Config.pm (parse_triggers):  New routine.  Each line
	of the triggers setting contains a trigger name and set of
	times at which the trigger should be invoked.
	(_str_to_clock)  Parse "yearly" "quarterly" "monthly" "weekly" "daily"
	and a new abbreviated format (e.g., 7m3d(8) for July 3, 8 am).

	* lib/Mj/Digest.pm (in_clock):  Handle hours relative to the 
	start of a year, or relative to the start of a particular month.

	* lib/Mj/Resend.pm (_r_strip_body):  New routine.  Discard
	attachments as required by the attachment_rules setting.

	* lib/Mj/Token.pm (confirm, consult, remind): Add 
	X-Loop: majordomo@example.com  header, to prevent loops.

2000-08-24  Darren Stalder  <torin@daft.com>

	* README: After the setup questions are asked, mention that you
	can prepare and use a response file.

	* setup/query_util.pl (prompt): Allow prompt to read from STDIN if
	there is any data waiting there.  This allows the installer to
	prepare a response file for the questions; very useful for
	packaging mj2.

2000-08-24  Michael Yount <csf@moscow.com>

	* bin/mj_wwwusr:  Include digests when the details about
	an individual list are shown.

	* lib/Majordomo.pm: (lists) Include digest names and
	descriptions in the data.
	(_report) Allow more complicated time spans, e.g.,
	2w3d4h for the last 2 weeks, 3 days, and 4 hours.
	(Thanks to Dave Wolfe for the suggestion.)
	(trigger) Add new trigger options for finer control.
	The following abbreviations are available:
	b (bounce) or v (vacation) ... expire bounce and vacation data.
	c (checksum) ... expire duplicate checksum/id data.
	da (daily) ... all of the other tasks, except digests.
	di (digest) or h (hourly) ... issue digests.
	l (log) ... expire old log entries.
	s (session) ... expire old session data.
	t (token) ... expire old tokens and temporary passwords.

	* lib/Mj/BounceParser.pm (parse): Anchor matches at the
	beginning of the envelope information.

	* lib/Mj/Format.pm (lists):  Display digests in "aux" mode.

	* lib/Mj/List.pm: (_time_to_str) New routine.  Convert a
	time span abbreviation (such as 2w3d4h) to a count of seconds.
	(describe_class) Deal with vacation spans correctly.

2000-08-23  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (lists, who_start):  Treat a search
	pattern not enclosed in delimiters to a case-insensitive
	substring match.

2000-08-21  Michael Yount <csf@moscow.com>

	* files/en/config/archive_url:  New configuration
	variable, used by mj_wwwusr and the message_headers
	setting (ARCURL substitution in Mj::Resend::_post.)

	* files/en/config/sublists:  New configuration variable.
	The lists-aux command will only display auxiliary lists
	explicity mentioned in this setting.  The createlist-regen
	command will only create mail aliases for sublists included
	in this setting.  Each line of the array consists of
	a sublist name, followed by an optional description.
	The description appears in the output of the lists-aux 
	command.

	* bin/mj_wwwusr:  Overhaul formatting.  The introductory
	page is now very simple, offering only instructions.  The
	lists page contains a link to a separate page for each mailing 
        list.

	* lib/Majordomo.pm: (get_all_lists) Take a regular expression,
	to allow the list names to be searched.
	(list_config_set_to_default) Remove calls to inform().
	(_createlist) Create aliases only for auxiliary lists
	named in the "sublists" configuration setting.
	(lists) Allow a regular expression to be used, to search
	the list of lists.  Add new data (list address, owner
	address, number of subscribers, archive URL) to the 
	output of the lists-aux command.
	(report_done) Include a list of auxiliary lists in
	summary mode, to compensate for the new restrictions
	to the lists-aux command.
	
	* lib/Mj/Config.pm (parse_sublist_array):  New routine.
	Used with the "sublists" variable.  Each line consists
	of a list name, followed by an optional description.

	* lib/Mj/List.pm (count_subs):  New routine.  Count
	the number of subscribers in a list or auxiliary list.

2000-08-20  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/Resend.pm: Strip trailing whitespace in code.

	* lib/Mj/MailOut.pm (mail_message): Fix undeclared variable
	problem.
	Strip trailing whitespace in code.
	(handle_bounce_user): Take all arguments in a hash.

	* lib/Mj/Config.pm (parse_bounce_rules): New function to parse
	bounce_rules variable.  Works mostly like parse_delivery_rules.
	Strip trailing whitespace in code.
	Hook up parse_bounce_rules function to the appropriate type.
	(_compile_rule): Fix handling of two-character numeric
	comparisons, which have been broken for forever.

	* lib/Mj/CommandProps.pm: Add variables and actions for "_bounce"
	fake command, for use in bounce_rules.
	Strip trailing whitespace in code.

	* bin/mj_queuerun: Strip trailing whitespace in the code.

	* lib/Mj/MailOut.pm (handle_bounce): Split out 'M'-type bounce
	processing, like we did with 'T'-type bounces.
	(handle_bounce_message): New function to deal with bounced
	messages.

	* lib/Mj/List.pm (bounce_add): Add logging.

2000-08-19  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/BounceParser.pm (parse_msn): Add parser for MSN-format
	bounces.

	* lib/Mj/Config.pm (_compile_rule): Fix broken operator comparison
	regexp.

2000-08-19  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (_digest):  Add "status" mode,
	which allows the current state of the digests to be 
	viewed.

	* lib/Mj/Token.pm (gen_latchkey):  Use new "latchkey_lifetime"
	global configuration variable, which gives the lifetime of
	a temporary password in minutes.

2000-08-18  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (_rekey):  Allow the registry
	to be verified or repaired, based upon the subscriber
	databases, if the registry is corrupted.

2000-08-15  Michael Yount <csf@moscow.com>

	* bin/mj_wwwadm:  Further refine the output of
	the configshow command (menus for enumerated types,
	add links to help pages).

	* files/en/config/log_lifetime:  New variable.  Log
	entries older than this age (default 31 days) will be
	deleted during the daily trigger.

	* lib/Majordomo.pm (set):  Support "check" mode, which
	allows settings to be reviewed but not changed.

	* lib/Mj/CommandProps.pm, lib/Mj/Parser.pm (parse_args):  
	Rearrange 'arguments' data to make per-mode adjustments easier.

	* lib/Mj/Inform.pm (l_expire):  New routine.  Remove log
	entries older than the log_lifetime setting.

2000-08-13  Michael Yount <csf@moscow.com>

	* files/en/ack_archive:  New file, sent when a post is
	archived but not distributed.

	* bin/mj_wwwadm:  Add forms to the output of the configshow
	command to allow settings to be changed or set to the default.
	(only one setting at a time may be changed)

	* lib/Majordomo.pm: (_alias_reverse_lookup) Optionally
	include the bookkeeping alias in the result.  Return
	keys instead of stripsource values.
	(alias) Use list instead of listref error return values.
	(configshow) Indicate if a global password is 
	required to change a particular variable.
	(_changeaddr) Replace the bookkeeping alias correctly.
	(reject) Allow DATE substitution (date of original request).
	(set, _set) Use "check" and "force" variables to allow
	settings to be seen without changing them, and to allow
	list owners to override allowed_* settings that limit
	the changes available to subscribers.

	* lib/mj_cf_data.pl: Remove ack_denials_always.
	Add values for 'flags' variables to allow sanity checks.

	* lib/Mj/Config.pm (parse_flags):  Check the validity
	of flags in list settings (allowed_flags, aliases, ...)

	* lib/Mj/List.pm: (%flags) Add ackdeny, ackpost, ackreject,
	and ackstall settings for fine-grained selection of acknowledgements.
	(set) Implement allowed_classes and allowed_flags checks,
	which limit the settings which may be changed by subscribers.
	(make_setting) Deal with group settings: the ackall and
	ackimportant flags now turn on all of the individual ack flags,
	and the noack flag turns them all off.
	(should_ack) New routine.  Determine whether a certain action
	requires an ack to be sent to the victim.
	(aux_get_member) New routine.  Return the auxiliary list
	data for a particular address.
        
	* lib/Mj/Resend.pm: (post) Include the sublist, date,
	and message author in the variable substitutions.
	(_post) Send an acknowledgement if warranted.

	* lib/Mj/Token.pm (t_accept):  Acks for posted messages
	are handled by Mj::Resend::_post.  Determine if an
	ack was sent in this case.

2000-08-12  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/mj_cf_data.pl: Add bounce_rules variable.

	* lib/Mj/MailOut.pm (handle_bounce): Fix busted indentation.

2000-08-10  Michael Yount <csf@moscow.com>

	* lib/Mj/Access.pm (list_access_check):  Allow reasons
	to be described for commands other than "post."

	* lib/Mj/Config.pm (parse_table):  Allow parens within
	quotes and vice-versa when parsing multifield lines.

2000-08-09  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm:  (dispatch) Treat an "owner" command as
	a "bounce" during inform() if a bad address was supplied.
	Set the "user" to the message author and put bad addresses
	into the command line variable.

	* lib/Mj/MailOut.pm (handle_bounce):  Return the bad
	addresses (if any were found) and message author (always).

	* bin/mj_wwwadm, lib/Mj/Format.pm (who):  Show bounce diagnostics.

	* lib/Mj/List.pm (bounce_add),  lib/Mj/SubscriberList.pm: 
	Add bounce diagnostics to saved/displayed data.

	* lib/Mj/Deliver/Dest.pm, lib/Mj/Deliver/Envelope.pm:
	Report non-fatal failures during RCPT TO as pseudo-exim bounces
	to the message sender. (Thanks to Paul Hancock.)

2000-08-08  Michael Yount <csf@moscow.com>

	* files/en/wwwadm_head, files/en/wwwadm_help:  Move the 
	command form and introduction from mj_wwwadm to separate files
	to allow easier customization.

	* lib/Mj/CommandProps.pm, lib/Mj/Parser.pm (parse_args):
	Split variable names in the configdef and configshow commands
	on either commas or spaces.

2000-08-07  Michael Yount <csf@moscow.com>
 
	* lib/Mj/Config.pm (set):  Initialize value if it is not 
	defined.  (Thanks to Todd Goodman.)

2000-08-06  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (_createlist):  Create the archive
	directory unless "noarchive" mode is specified.  Generate
	a password randomly.  Send the "new_list" file to the 
	owner unless "nowelcome" mode was specified.
	Add "destroy" mode, which will remove a list by renaming
	its directory, but only if there are no subscribers.
	Destroy mode also regenerates the aliases.

2000-08-05  Michael Yount <csf@moscow.com>

	* lib/Mj/List.pm (make_setting):  Allow nomail-return to
	work for vacations that are not timed.

2000-08-04  Michael Yount <csf@moscow.com>

	* bin/mj_email, bin/mj_enqueue:  delete unneeded envvars.

	* bin/mj_queuerun:  randomize directories and files. 
	Fix indentation.  

	* bin/mj_wwwadm:  simplify command form maintenance.

	* files/en/consult, files/en/consult_noweb:  Suggest
	that the accepter type an explanation.

	* lib/Majordomo.pm: (new) Treat the registry as
	a subscriber list for the GLOBAL list.  This allows
	the Deliver module to distribute messages to addresses
	in the registry.
	(announce) New command.  Distribute a file to one
	or more classes of subscribers.  Each message is
	sent as a probe, with the recipient in the To: header.
	This could be used for periodic reminders, or 
	announcements that need to reach 'digest' and 'nomail'
	subscribers immediately.
	(archive_chunk) Allow the type of digest for the
	archive-get command to be specified in the mode ("-mime"
	for mime; text otherwise.)
	(report) New, iterated command.  Obtain raw or summarized
	data for recent log entries for a mailing list.
	The data can be constrained by action or by date.
	(get_all_lists, _make_list) Make DEFAULT data available 
	to Mj::List::new when all of the lists are being 
	loaded, to save redundant lookups.

	* lib/mj_cf_defs.pl: Add 'MSGRCPT' to admin_header checks.

	* lib/Mj/CommandProps.pm, lib/Mj/Format.pm:  Support new
	announce and report commands.

	* lib/Mj/Config.pm:  Use existing data for the DEFAULT
	list when Majordomo::get_all_lists is run.

	* lib/Mj/Deliver.pm:  (deliver) Support delivery to 
	addresses in the registry.  Addresses subscribed to 
	at least one list are in the "each" class.  Addresses
	not subscribed to any lists are in the "nomail" class.

	* lib/Mj/List.pm:  (_digest_classes) New routine.  Return
	a list of all possible digest classes.

	* lib/Mj/MailOut.pm:  (probe) New routine.  Probe all
	addresses in the classes provided.  This is used by
	the announce command.

	* lib/Mj/Parser.pm:  (parse_entity) Test for existence
	of a bodyhandle before using it.  (Thanks to Paul Hancock.)

	* lib/Mj/Deliver/Dest.pm:  (make_envelope)  Add 'personal'
	variable, which is set if there is only one recipient.

	* lib/Mj/Deliver/Envelope.pm:  (new, address, send)
	If a message is personal, substitute the recipient's
	address for the variable $MSGRCPT during delivery.

2000-07-30  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm: (dispatch) Inform on post_done, but not
	on post_start.
	(set, who)  Use arg3 instead of arg2 for the auxiliary list,
	because arg2 is used by the access rules to offer reasons. 
	(accept)  Allow a comment to be given on the command line,
	as with the reject command.
	
	* lib/Mj/Access.pm: (list_access_check) Make the command mode 
	available to the access rules.

	* lib/Mj/Format.pm: (post) Do not print comment on success.
	(accept) Indicate whether or not the victim was notified.

	* lib/Mj/List.pm: (valid_aux) Rename validate_aux to valid_aux
	and use it to untaint the sublist name, ala valid_list.

2000-07-28  Michael Yount <csf@moscow.com>

	* lib/Mj/CommandProps.pm:  Use "auxlist" instead of "sublist."
	The argument names must be alphabetical in relation to the
	order in which the arguments appear on the command line.
	Using "auxlist" allows more flexibility in choosing names
	for the other arguments.

	* lib/Majordomo.pm, lib/Mj/Format.pm:  Combine code for
	the who and auxwho commands.
 
	* lib/Mj/List.pm (expire_subscriber_data): Expire auxiliary
	list data.

2000-07-27  Michael Yount <csf@moscow.com>

	* lib/Mj/Archive.pm:  Make archives of auxiliary lists available.
	(add_start)  Use time derived from the Date: header.
	
	* lib/Mj/Resend.pm (_post):  Archive messages sent to 
	auxiliary lists.

2000-07-26  Michael Yount <csf@moscow.com>

	* bin/mj_wwwadm:  Add support for multiple domains.

	* bin/mj_wwwusr:  Restructure to override Mj::Format routines
	for the help, lists, and show commands.  
	Add support for multiple domains.
	Add support for the help and changeaddr commands.
	(Thanks to Sudhakar Chandrasekharan for the help suggestion.)

	* lib/Majordomo.pm (subscribe):  Set the matches_list variable
	if someone attempts to add the -unsubscribe alias to the list.

2000-07-25  Michael Yount <csf@moscow.com>

	* bin/mj_email, bin/mj_enqueue: Add options for new aliases
	  -c COMMAND    Issue a command (-subscribe, -unsubscribe)
	  -M            Forward message to moderators (-moderator)
	  -x SUBLIST    Post a message to an auxiliary list.
	At present, qmail support does not include auxiliary lists.
	The -moderator alias follows the same conventions as the
	-owner alias.  The auxiliary list aliases follow the same
	conventions as the resend (main list) alias.
	(Thanks to Brock Rozen for suggesting the -(un)subscribe aliases.)
      
	* bin/mj_queuerun: Handle altered queue file names for new aliases.
	The file names will end with a comma, followed by an auxiliary
	list name or command name or 'M' (for -moderator).
	Remove the unused qmail code.

	* bin/mj_wwwadm, bin/mj_wwwusr: Add support for latchkeys. 
	Instead of sending the password back to the client with the
	results, a temporary password is created with a limited lifetime
	(one hour by default).

	* lib/Majordomo.pm: 
	(dispatch)  Convert a latchkey into a permanent password.
	(gen_cmdline) Take into consideration messages posted to
	auxiliary lists.
	(_createlist)  Use the "aliases" setting to determine
	which aliases to use.  Include alias and sublist data
	when using the MTAConfig module.
	(reject) Include datum concerning whether or not an 
	acknowledgement was sent to the victim.
	(set, _set) Allow use of the "aux" mode to change the 
	settings for an auxiliary list.

	* lib/Mj/Access.pm (_a_forward):  Allow a posted message
	to be forwarded to a different address.

	* lib/Mj/CommandProps.pm: Allow the "sublist" variable
	to be used by the access rules for the "post" command.
	Allow the use of auxiliary lists with the "set-aux" command.

	* lib/Mj/Deliver.pm (deliver):  Obtain the list of subscribers
	from an auxiliary list, if that is the destination.

	* lib/Mj/Format.pm: (auxwho)  Use expanded format, like
	the "who-enhanced" command.
	(reject) For consult tokens, indicate whether or not the
	victim was informed.
	(set) Indicate the sublist if "aux" mode is used.
	(tokeninfo) Indicate the number of approvals required.
  
	* lib/Mj/List.pm:  Cease using AddressList.pm.  Auxiliary
	lists now use the SubscriberList module.
	(set, make_setting) Allow settings to be changed for 
	auxiliary lists.  Digest mode is not supported for sublists.
	Ensure that digest names are converted to lower case.
	(aux_add) Extend the data to accommodate the fields of
	a SubscriberList.
	(aux_get_chunk) Return all of the data instead of just the address.
	(aux_get_matching) New subroutine.
	(aux_rekey) Allow an easy transition from AddressList to 
	SubscriberList by rekeying.
	(moderators) New subroutine.  Obtain a list of moderators from
	1) A named auxiliary list
	2) The 'moderators' auxiliary list
	3) The 'moderators' configuration setting
	4) The 'moderator' configuration setting
	5) The 'sender' configuration setting
	in decreasing order of precedence.
	(_make_aux) Use SubscriberList instead of AddressList
	(validate_aux) New subroutine. Initialize an auxiliary list if it
	already exists.

	lib/Mj/MTAConfig.pm: (add_alias) Allow the use of optional
	(moderator, subscribe, unsubscribe, and auxiliary list) aliases.
	(regen_aliases) Sort the lists alphabetically.

	lib/Mj/MailOut.pm: (deliver) Add the sublist to the argument list.
	(owner_done) Direct the message to the moderators instead of
	the owner, if required.

	lib/Mj/Resend.pm: (post, _post) Allow messages to be posted
	to auxiliary lists.  Add 'sublist' to the access variables.
	Do not increase the sequence number, archive the message,
	or issue digests if the message is posted to a sublist.

	lib/Mj/Token.pm: (consult) Allow moderator groups (auxiliary
	lists) and group sizes to be used.
	(t_expire) Expire latchkeys (temporary passwords).
	(_make_latchkeydb, gen_latchkey, validate_latchkey) New subroutines.
	Latchkeys are temporary passwords used by the WWW interfaces
	to prevent the CGI scripts from passing a permanent password
	back to the client.

2000-07-21  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (connect): Call inform() if a connection
	attempt fails due to access restrictions.
 
	* lib/Mj/Resend.pm (_add_fters): Avoid adding footers
	and fronters to multipart/alternative messages.
	(Thanks to Joe Tremblay.)

2000-07-18  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm (reject):  Allow an explanation or a file to
	be specified when a token is rejected.  The usual variable
	substitutions are available for use in the file.

2000-07-17  Michael Yount <csf@moscow.com>

	* bin/mj_wwwadm:  Add hypertext links to help pages.
	(Thanks to Sudhakar Chandrasekharan for the suggestion.)

2000-07-16  Michael Yount <csf@moscow.com>

	* lib/Mj/TextOutput.pm:  Remove entirely.

	* lib/Majordomo.pm:  Remove the 'auth' variable from the
	request hash, and make the 'interface' variable specific
	to each session, rather than to each request.  This reduces
	the number of arguments to routines like global_config_get
	and list_access_check by 2.

2000-07-07  Michael Yount <csf@moscow.com>

	* lib/Mj/Parser.pm (parse_args):   Deal with attachments.  If a command 
	accepts here arguments and is iterated,  set the appropriate request
	variable to the attachment file handle.  Otherwise, read
	the data from the file handle into the argument array.
	(Only the post and put commands will use the file handle.)

2000-07-03  Michael Yount <csf@moscow.com>

	* bin/mj_confirm:  Include domain in HTML form (from Olivier Prenant).
	Use Format to present output of sessioninfo.
	Show the expiration date of a token.

2000-07-01  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/BounceParser.pm (parse_lotus): Would accept an all-blank
	bounce.
	(parse_softswitch): Would accept an all-blank bounce.

2000-07-01  Michael Yount <csf@moscow.com>

	* lib/Majordomo.pm: (archive_chunk)  Use existing
	Mj::List routines to retrieve messages in 'immediate' mode.

2000-06-30  Michael Yount <csf@moscow.com>

	* bin/mj_wwwadm: Formatting rewrite; override Mj::Format 
	routines for the showtokens, tokeninfo, and who commands.

	* lib/Majordomo.pm:
	(faq_start, info_start, intro_start) Remove temporary files.
	(createlist) Use "newlist" variable instead of "list."
	(sessioninfo) Rename to sessioninfo_start.  Treat
	sessioninfo as an iterated core routine.
	(showtokens) Allow tokens shown to be limited to a
	particular command.  Include the size of the spool
	file in the output for posted messages.

2000-06-27  Michael Yount <csf@moscow.com>

	Use new core function calling conventions.

2000-06-26  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Majordomo.pm (createlist): Return values were done
	improperly for some reason.

	* lib/Mj/BounceParser.pm: Renamed from Bf/Parser.pm.

2000-06-25  Jason Tibbitts  <tibbs@morpheus.math.uh.edu>

	* lib/Mj/List.pm (bounce_gen_stats): Fixed calculation of overload
	stats.

	* Rotated old ChangeLog entries.

